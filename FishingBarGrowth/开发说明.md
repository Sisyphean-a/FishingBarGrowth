# 钓鱼条无限增长 Mod 开发说明

## 项目概述

本项目完全实现了《星露谷物语》钓鱼条无限增长功能。

## 已实现功能

### ✅ 核心功能
1. **无限增长机制**: 钓鱼条长度不再受等级限制,可以无限增长
2. **产量驱动**: 默认每钓10条鱼,钓鱼条增加1像素(可配置)
3. **精准统计**: 自动过滤垃圾和藻类(ID: 152, 153, 157),只统计真正的鱼类
4. **追溯既往**: 安装后立即获得之前捕获数量带来的加成
5. **Harmony补丁**: 使用动态目标方法匹配,兼容性最好

### ✅ HUD显示系统
手持鱼竿时在屏幕左下角显示:
- **已钓鱼数**: 显示当前总共钓到的鱼数
- **钓鱼条长度**: 显示当前钓鱼条的实际长度
- **详细分解**: 显示基础长度(等级+装备)和奖励长度(钓鱼数量)
- **智能提示**: 未钓鱼时显示"请先开始钓鱼以获取数据"
- **可配置位置**: 支持自定义HUD位置
- **半透明背景**: 美观且不影响游戏体验

### ✅ 配置系统
通过Generic Mod Config Menu提供完整的配置界面:

**主要设置**
- **启用/禁用Mod**: 随时开关功能
- **每像素需要的鱼数**: 1-100可调,默认10
- **最大钓鱼条高度**: 0-1000像素,0表示无限制,默认600
- **排除藻类**: 是否将海草和藻类计入统计

**HUD显示设置**
- **显示钓鱼HUD**: 开关HUD显示
- **HUD水平位置**: 0-500像素,默认20
- **HUD垂直位置**: 0-500像素,默认180

**调试设置**
- **调试信息**: 在控制台显示详细信息

### ✅ 多语言支持
- 中文 (zh.json)
- 英文 (default.json)

## 项目结构

```
FishingBarGrowth/
├── Program.cs (ModEntry)          # Mod主入口类
├── ModConfig.cs                   # 配置类
├── FishCounter.cs                 # 鱼类统计工具
├── BobberBarPatch.cs             # Harmony补丁
├── FishingHUD.cs                 # HUD显示类
├── IGenericModConfigMenuApi.cs   # GMCM API接口
├── manifest.json                  # Mod清单
├── i18n/
│   ├── default.json              # 英文翻译
│   └── zh.json                   # 中文翻译
├── README.md                      # 用户文档
└── 开发说明.md                    # 开发文档
```

## 技术实现细节

### 1. 鱼类统计 (FishCounter.cs)
- 使用`Game1.player.fishCaught.Pairs`遍历钓鱼统计
- 通过`ItemRegistry.GetDataOrErrorItem()`获取物品数据
- 检查`ObjectType`和`Category=-4`字段判断是否为鱼类
- 支持排除藻类和海草(ID: 152, 153, 157)
- 详细的调试日志系统

### 2. Harmony补丁 (BobberBarPatch.cs)
- 目标: `StardewValley.Menus.BobberBar`构造函数
- 类型: Postfix (后置补丁)
- 使用`HarmonyTargetMethod`动态匹配构造函数
- 通过反射修改私有字段`bobberBarHeight`
- 保存基础高度、奖励像素、最终高度供HUD使用
- 使用`HasFishingData`标志指示是否有有效数据

### 3. HUD显示 (FishingHUD.cs)
- 在`RenderedHud`事件中绘制
- 检测玩家是否手持`FishingRod`
- 从`BobberBarPatch`获取实时钓鱼数据
- 未钓鱼时显示提示信息
- 使用`SpriteBatch`绘制半透明背景和文本
- 支持自定义位置

### 4. 配置集成 (Program.cs)
- 在`GameLaunched`事件中注册GMCM
- 使用lambda表达式实现getter/setter
- 支持翻译字符串
- 注册`RenderedHud`事件处理HUD绘制

## API兼容性

### Stardew Valley 1.6 变化
本mod已适配1.6版本的以下变化:
- ✅ `fishCaught`从`Dictionary<int, int[]>`改为`SerializableDictionary<string, int[]>`
- ✅ `Game1.objectInformation`已移除,改用`ItemRegistry`
- ✅ 物品ID从int改为string
- ✅ 使用`Pairs`属性遍历SerializableDictionary

## 构建和部署

### 构建命令
```bash
dotnet build FishingBarGrowth/FishingBarGrowth.csproj
```

### 自动部署
ModBuildConfig会自动:
1. 将mod复制到游戏Mods文件夹
2. 生成发布zip包

### 输出位置
- **游戏Mods**: `D:\SteamLibrary\steamapps\common\Stardew Valley\Mods\FishingBarGrowth`
- **发布包**: `bin\Debug\net6.0\FishingBarGrowth 1.0.0.zip`

## 测试建议

### 基础测试
1. 启动游戏,检查SMAPI控制台是否有错误
2. 进入游戏,打开配置菜单(需要GMCM)
3. 尝试钓鱼,观察钓鱼条长度

### 功能测试
1. **统计测试**: 查看已钓鱼数,计算应得像素
2. **配置测试**: 修改配置,重新钓鱼验证
3. **藻类过滤**: 钓海草/藻类,确认不计入
4. **最大高度**: 设置较小的最大值,验证限制

### 调试模式
启用"显示调试信息"配置项,每次钓鱼时会在控制台显示:
```
钓鱼条高度已修改: 原始=96px, 奖励=50px (总鱼数=500), 最终=146px
```

## 已知限制

1. **多人游戏**: 客户端mod,每个玩家需要单独安装
2. **兼容性**: 可能与大幅修改钓鱼机制的mod冲突
3. **性能**: 每次钓鱼时计算一次,性能影响可忽略

## 未来改进方向

1. 添加非线性增长曲线(如对数增长)
2. 支持不同鱼类的权重系统
3. 添加成就系统
4. 支持自定义钓鱼条纹理

## 依赖项

- **必需**: SMAPI 3.18.0+
- **可选**: Generic Mod Config Menu

## 开发环境

- .NET 6.0
- Stardew Valley 1.6+
- Pathoschild.Stardew.ModBuildConfig 4.4.0

## 许可证

MIT License

## 作者

Xavier Nico

## 致谢

- 基于详细的技术分析文档实现
- 使用SMAPI和Harmony框架
- 集成Generic Mod Config Menu

